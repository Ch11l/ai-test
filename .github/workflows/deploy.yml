name: Deploy to VPS

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. æ‹‰å–ä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. å®‰è£… Node.js ç¯å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # 3. å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
    - name: Install and Build
      run: |
        cd vue-todo
        npm install
        npm run build
      # æ­¤æ—¶ dist æ–‡ä»¶å¤¹å·²ç»ç”Ÿæˆåœ¨ GitHub çš„è™šæ‹Ÿæœºé‡Œäº†

    # 4. æŠŠ dist æ–‡ä»¶å¤¹ä¼ åˆ°ä½ çš„ VPS
    - name: SCP Deploy
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "vue-todo/dist/*"   # ğŸ‘ˆ å‘Šè¯‰å®ƒæˆå“åœ¨å­æ–‡ä»¶å¤¹é‡Œ
        target: "/var/www/html"
        strip_components: 2         # ğŸ‘ˆ è¿™é‡Œæ”¹æˆ 2 (å› ä¸ºè¦å‰¥ç¦» vue-todo å’Œ dist ä¸¤å±‚çš®)

    # 5. (å¯é€‰) è¿œç¨‹æ‰§è¡Œå‘½ä»¤åˆ·æ–° Nginx
    - name: Restart Nginx
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          nginx -t
          systemctl reload nginx